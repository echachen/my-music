name: Build songlist.json

on:
  push:
    paths:
      - "*.mp3"
  workflow_dispatch: # ğŸ‘ˆ å…è®¸ä½ åœ¨ GitHub é¡µé¢ç‚¹æŒ‰é’®è¿è¡Œ

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Generate songlist.json
        run: |
          echo "[" > songlist.json
          # æ‰«ææ‰€æœ‰ mp3 æ–‡ä»¶
          files=(*.mp3)
          count=${#files[@]}
          for ((i=0; i<$count; i++)); do
            f="${files[$i]}"
            [ -e "$f" ] || continue
            title="${f%.mp3}"
            
            # ä½¿ç”¨ Python ç¡®ä¿ä¸­æ–‡ç›´æ¥æ˜¾ç¤ºï¼Œä¸”æ ¼å¼ç™¾åˆ†ç™¾æ­£ç¡®
            item=$(python3 -c "import json; print(json.dumps({'title': '$title', 'src': 'https://echachen.github.io/my-music/$f'}, ensure_ascii=False))")
            
            echo "  $item" >> songlist.json
            # å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªï¼Œå°±åŠ é€—å·
            if [ $i -lt $((count-1)) ]; then
              echo "," >> songlist.json
            fi
          done
          echo "]" >> songlist.json

      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add songlist.json
          git commit -m "Auto update songlist.json" || exit 0
          git push origin main
