name: Build songlist.json

on:
  push:
    paths:
      - "*.mp3"
      - ".github/workflows/**" # æ–¹ä¾¿è°ƒè¯•
  workflow_dispatch: # ğŸ‘ˆ å¢åŠ æ‰‹åŠ¨è§¦å‘æŒ‰é’®ï¼Œä¸ç”¨æ¯æ¬¡éƒ½ä¼  MP3 ä¹Ÿèƒ½æµ‹è¯•

jobs:
  build:
    runs-on: ubuntu-latest
    permissions: # ğŸ‘ˆ å…³é”®ï¼šèµ‹äºˆ Action å†™å…¥æ–‡ä»¶çš„æƒé™
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Generate songlist.json
        run: |
          echo "[" > songlist.json
          first=true
          # æ‰«æå½“å‰ç›®å½•ä¸‹æ‰€æœ‰ mp3
          for f in *.mp3; do
            [ -e "$f" ] || continue
            filename=$(basename "$f")
            title="${filename%.mp3}"
            
            # ä½¿ç”¨ Python å¤„ç† JSON è½¬ä¹‰ï¼Œé˜²æ­¢æ­Œåæœ‰ç‰¹æ®Šå­—ç¬¦å¯¼è‡´å‡ºé”™
            esc_title=$(printf '%s' "$title" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read().strip())[1:-1])')
            esc_file=$(printf '%s' "$f" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read().strip())[1:-1])')

            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> songlist.json
            fi
            # è¿™é‡Œçš„é“¾æ¥ä¸è¦å†™æ­» CDNï¼Œæ–¹ä¾¿åç»­è°ƒè¯•
            echo "  { \"title\": \"$esc_title\", \"src\": \"https://echachen.github.io/my-music/$esc_file\" }" >> songlist.json
          done
          echo "]" >> songlist.json

      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add songlist.json
          git commit -m "Auto update songlist.json" || exit 0
          git push origin main  # ğŸ‘ˆ ç¡®ä¿è¿™é‡Œå†™å¯¹ä½ çš„åˆ†æ”¯åï¼ˆé€šå¸¸æ˜¯ main æˆ– masterï¼‰
