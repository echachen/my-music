<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Music Station</title>

<!-- Shikwasa 样式 -->
<link rel="stylesheet" href="https://unpkg.com/shikwasa@2.2.1/dist/shikwasa.min.css">

<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont;
    background: #f7f7f7;
    padding: 20px;
  }
  #status {
    margin-bottom: 12px;
    color: #555;
    font-size: 14px;
  }
</style>
</head>

<body>

<div id="status">⏳ 正在加载音乐列表…</div>
<div id="player"></div>

<!-- Shikwasa JS -->
<script src="https://unpkg.com/shikwasa@2.2.1/dist/shikwasa.min.js"></script>

<script>
const CONFIG = {
  jsonUrl: 'https://echachen.github.io/my-music/songlist.json'
};

async function initMusicStation() {
  const statusEl = document.getElementById('status');

  try {
    /* ① 拉 JSON（加时间戳防缓存） */
    const res = await fetch(CONFIG.jsonUrl + '?t=' + Date.now());
    if (!res.ok) {
      throw new Error('HTTP ' + res.status);
    }

    /* ② 强制按文本读取，防 BOM / 非法字符 */
    const text = await res.text();

    let rawList;
    try {
      rawList = JSON.parse(text);
    } catch (e) {
      console.error('JSON 原始内容：', text);
      throw new Error('JSON 解析失败');
    }

    if (!Array.isArray(rawList)) {
      throw new Error('JSON 不是数组');
    }

    /* ③ 在代码里修复 URL（不改 JSON） */
    const musicList = rawList.map((item, index) => {
      if (!item.src) {
        throw new Error(`第 ${index + 1} 首歌缺少 src`);
      }

      return {
        title: item.title || `Track ${index + 1}`,
        artist: item.artist || '',
        cover: item.cover || '',
        src: encodeURI(item.src.trim())
      };
    });

    /* ④ 初始化播放器 */
    new Shikwasa({
      container: () => document.getElementById('player'),
      audio: musicList,
      themeColor: '#3b82f6',
      autoplay: false,
      loop: false
    });

    statusEl.textContent = `✅ 成功加载 ${musicList.length} 首歌曲`;

  } catch (err) {
    console.error(err);
    statusEl.textContent = '❌ 加载失败：' + err.message;
  }
}

initMusicStation();
</script>

</body>
</html>
